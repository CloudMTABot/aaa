#!/usr/bin/env groovy
@Library(['piper-lib', 'piper-lib-os']) _
import com.sap.icd.jenkins.Utils

dockerImg = "michdock/michdeploy:0.0.1"
MBT_VERSION = "0.2.4"

try {
    stage("Upload to Nexus") {
        node {
            deleteDir()
            def dockerImage = dockerImg
            measureDuration(script: this, measurementName: 'build_duration') {
                executeDocker(dockerImage: dockerImage) {
                    withCredentials([usernamePassword(credentialsId: 'nexus_upload_user', passwordVariable: 'PASSWORD', usernameVariable: 'USER')]) {
                        sh """
#                            echo \$MBT_VERSION
#                            curl -L https://raw.githubusercontent.com/SAP/cloud-mta-build-tool/master/VERSION -o VERSION
#                            MBT_VERSION=\$(cat VERSION)
#                            curl -L https://raw.githubusercontent.com/SAP/cloud-mta-build-tool/master/scripts/configpack -o configpack
                            curl -L https://github.com/SAP/cloud-mta-build-tool/releases/download/v\${MBT_VERSION}/cloud-mta-build-tool_\${MBT_VERSION}_Darwin_amd64.tar.gz -o cloud-mta-build-tool_\${MBT_VERSION}_Darwin_amd64.tar.gz
#                            curl -L https://github.com/SAP/cloud-mta-build-tool/releases/download/v\${MBT_VERSION}/cloud-mta-build-tool_\${MBT_VERSION}_Linux_amd64.tar.gz -o cloud-mta-build-tool_\${MBT_VERSION}_Linux_amd64.tar.gz
#                            curl -L https://github.com/SAP/cloud-mta-build-tool/releases/download/v\${MBT_VERSION}/cloud-mta-build-tool_\${MBT_VERSION}_Windows_amd64.tar.gz -o cloud-mta-build-tool_\${MBT_VERSION}_Windows_amd64.tar.gz
#                            artifactdeployer pack --script-file configpack --package-file ./cloud-mta-build-tool-pack -D mbtVersion=\$MBT_VERSION                          
#                            artifactdeployer deploy --package-file ./cloud-mta-build-tool-pack --artifact-version \$MBT_VERSION --repo-url http://nexusmil.wdf.sap.corp:8081/nexus/content/repositories/sap.milestones.manual-uploads.hosted --repo-user \$USER --repo-passwd \$PASSWORD
                        """
                    }
                }
            }
        }
    }
    stage("Update WING") {
        node {
            deleteDir()
            withCredentials([usernamePassword(credentialsId: 'github_user_config', passwordVariable: 'PASSWORD', usernameVariable: 'USER')]) {
                sh """
                    CURR_MBT_VERSION=$(grep '^RUN curl -L "https://github.com/SAP/cloud-mta-build-tool' ./Dockerfile) |  CURR_MBT_VERSION=${CURR_MBT_VERSION:76:5}
                    echo CURR_MBT_VERSION \$CURR_MBT_VERSION
                    echo MBT_VERSION \$MBT_VERSION
                    git clone https://github.wdf.sap.corp/devx-wing/mta-tools.git
                    cd mta-tools
                    git checkout -b update_mbt_\$MBT_VERSION
                    sed  -i "/\"version\":/s/${CURR_MBT_VERSION}/${MBT_VERSION}/" ./Dockerfile
                    sed  -i "s/${CURR_MBT_VERSION}/${MBT_VERSION}/" ./Dockerfile
                    git add ./Dockerfile
                    git config user.email "${USERNAME}"
                    git config user.name "${PASSWORD}"
                    git commit -m "Update MBT version ${MBT_VERSION}"
                    #Push quietly to prevent showing the token in log
                    git push -q https://github.wdf.sap.corp/devx-wing/mta-tools.git update_mbt_\$MBT_VERSION
 #                   git request-pull master ./
 #                   hub pull-request
                """
            }
        }
    }
} catch(Exception error) {
    mail body: """The upload of MBT to nexust is failing and requires your attention.
    Regards,
    FMS JaaS Server""".stripIndent().trim(), subject: 'MBT upload to nexus has failed!', to: 'michal.tall@sap.com'
    throw error;
}
